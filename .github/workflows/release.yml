name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: macos-14-xlarge  # arm64 runner required for TiktokenFFI.framework

    steps:
    - uses: actions/checkout@v4

    - name: Get version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Build release binary
      run: swift build -c release

    - name: Calculate SHA256
      id: sha256
      run: |
        cd .build/release
        echo "SHA256=$(shasum -a 256 yeet | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
        cd ../..

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: .build/release/yeet
        body: |
          ## Installation

          ### Homebrew
          ```bash
          brew install j-shelfwood/tap/yeet
          ```

          ### Manual
          ```bash
          curl -L https://github.com/j-shelfwood/yeet/releases/download/v${{ steps.get_version.outputs.VERSION }}/yeet -o yeet
          chmod +x yeet
          mv yeet /usr/local/bin/
          ```

          ## Checksums

          SHA256: `${{ steps.sha256.outputs.SHA256 }}`

          ## What's Changed

          See CHANGELOG.md for details.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update Homebrew Formula
      env:
        HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      run: |
        # Clone homebrew-tap repository
        git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/j-shelfwood/homebrew-tap.git /tmp/homebrew-tap
        cd /tmp/homebrew-tap

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Update formula
        cat > Formula/yeet.rb << 'EOF'
        class Yeet < Formula
          desc "Package your codebase for AI consumption in seconds"
          homepage "https://github.com/j-shelfwood/yeet"
          url "https://github.com/j-shelfwood/yeet/releases/download/v${{ steps.get_version.outputs.VERSION }}/yeet"
          version "${{ steps.get_version.outputs.VERSION }}"
          sha256 "${{ steps.sha256.outputs.SHA256 }}"
          license "MIT"

          depends_on :macos
          depends_on arch: :arm64

          def install
            bin.install "yeet"
          end

          test do
            # Test basic functionality
            assert_match "yeet", shell_output("#{bin}/yeet --version")

            # Test help command
            assert_match "Package source code for LLM consumption", shell_output("#{bin}/yeet --help")

            # Test list-only mode (dry run)
            system "#{bin}/yeet", "--list-only"
          end
        end
        EOF

        # Commit and push
        git add Formula/yeet.rb
        git commit -m "chore: Update yeet formula to v${{ steps.get_version.outputs.VERSION }}"
        git push origin main
